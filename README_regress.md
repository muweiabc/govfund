# regress.py - 使用linearmodels进行回归分析

## 功能说明

`regress.py` 是一个使用 `linearmodels` 库进行GDP与基金数量回归分析的脚本。与 `gdp_regression.py` 相比，它提供了更专业的计量经济学分析功能。

## 主要特性

- **专业回归分析**: 使用 `linearmodels.OLS` 进行普通最小二乘回归
- **详细错误处理**: 完整的异常处理和错误提示
- **数据验证**: 自动检查数据完整性和匹配情况
- **结果保存**: 自动保存回归结果到pickle文件

## 数据要求

### 输入文件

1. **`gdp.xlsx`** - GDP数据文件
   - 必须包含列: `年份`, `省级`, `人均地区生产总值/元`
   - 年份: 数值类型，用于筛选2008-2022年的数据
   - 省级: 省份名称，需要与其他数据中的省份名称一致
   - 人均地区生产总值/元: 数值类型，作为因变量

2. **`govfund_analysis_results.xlsx`** - 基金分析结果文件
   - 必须包含列: `省份`, `成立年份`, `基金数量`
   - 省份: 省份名称，需要与其他数据中的省份名称一致
   - 成立年份: 数值类型，用于匹配GDP数据的年份
   - 基金数量: 数值类型，作为自变量

3. **`2003-2023各省分行业全社会固定资产投资额.xlsx`** - 固定资产投资数据文件
   - 必须包含省份列和年份列
   - 自动识别总投资列（包含"总"、"合计"、"总计"、"全社会"等关键词）
   - 固定资产投资额: 数值类型，作为自变量

4. **`2000-2023年各省份城镇化水平.xlsx`** - 城镇化率数据文件
   - 必须包含Sheet: "原始版本"
   - 行索引为省份名称，列为年份
   - 城镇化率: 数值类型，作为自变量

### 数据格式要求

- 省份名称必须完全一致（如"北京" vs "北京"，不能是"北京" vs "北京市"）
- 年份格式必须一致（如都是整数年份）
- 数值列不能包含非数值数据

## 使用方法

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行回归分析

```bash
python regress.py
```

### 3. 测试数据兼容性

```bash
python test_regress.py
```

## 执行流程

1. **文件检查**: 验证必要文件是否存在
2. **数据读取**: 读取GDP和基金数据文件
3. **数据验证**: 检查列名、数据类型和数据范围
4. **数据匹配**: 根据省份和年份匹配GDP与基金数据
5. **回归分析**: 使用OLS进行回归分析
6. **结果输出**: 显示回归结果并保存到文件

## 输出结果

### 控制台输出

- 文件检查状态
- 数据读取和验证信息
- 数据匹配统计
- 回归分析结果摘要

### 文件输出

- `regression_results.pickle`: 包含完整回归结果的pickle文件

## 错误处理

### 常见错误及解决方案

#### 1. 文件不存在错误
```
✗ 错误: 找不到GDP文件 'gdp.xlsx'
```
**解决**: 确保文件存在于当前工作目录

#### 2. 列名不匹配错误
```
✗ 错误: GDP文件缺少必要的列: ['年份']
```
**解决**: 检查Excel文件的列名，确保包含必要的列

#### 3. 数据匹配失败
```
✗ 错误: 没有有效的数据进行回归分析
```
**可能原因**:
- 年份范围不匹配
- 省份名称不一致
- 数据中没有重叠的年份-省份组合

**解决**: 统一年份和省份的格式

#### 4. 库依赖错误
```
✗ linearmodels库未安装
```
**解决**: 运行 `pip install linearmodels`

### 调试建议

1. **运行测试脚本**: 首先运行 `python test_regress.py` 检查数据状态
2. **检查列名**: 确认Excel文件的列名与脚本期望的列名一致
3. **检查数据格式**: 查看数据类型和内容，确保格式正确
4. **检查匹配**: 确认年份和省份信息是否一致

## 与gdp_regression.py的区别

| 特性 | regress.py | gdp_regression.py |
|------|------------|-------------------|
| 回归库 | linearmodels | scikit-learn |
| 分析功能 | 专业计量经济学 | 机器学习 |
| 错误处理 | 详细 | 详细 |
| 可视化 | 无 | 完整图表 |
| 结果保存 | pickle格式 | Excel格式 |
| 适用场景 | 学术研究 | 数据探索 |

## 技术细节

### 回归模型

使用 `statsmodels.OLS` 进行多元线性回归：

```python
# 解释变量包括：
# 1. 基金数量
# 2. 城镇化率  
# 3. 固定资产投资

model = OLS(y_df, x_df_with_constant)
results = model.fit()
```

回归方程：
```
人均GDP = α + β₁×基金数量 + β₂×城镇化率 + β₃×固定资产投资 + ε
```

### 数据筛选

- 只分析2008-2022年的数据
- 只使用有基金数据的记录
- 自动跳过包含空值的记录
- 自动匹配省份名称格式（支持"北京"、"北京市"、"北京省"等）
- 自动识别固定资产投资文件中的总投资列

### 结果保存

回归结果保存为pickle格式，可以使用以下代码加载：

```python
import pickle
with open('regression_results.pickle', 'rb') as f:
    results = pickle.load(f)
print(results.summary())
```

## 注意事项

1. **数据质量**: 确保数据中没有缺失值和异常值
2. **格式一致**: 省份名称和年份格式必须完全一致
3. **样本数量**: 建议样本数量不少于10个，以保证回归结果的可靠性
4. **依赖库**: 需要安装linearmodels库

## 获取帮助

如果遇到问题：

1. 查看控制台输出的详细错误信息
2. 运行 `python test_regress.py` 进行诊断
3. 检查数据文件格式和内容
4. 参考错误处理部分的解决方案
